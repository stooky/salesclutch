{% extends "base.html" %}

{% block title %}Upload Call - SalesClutch{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Analyze Sales Call</h1>
    <p class="text-gray-400 mb-8">Upload a call transcript or audio file for Sandler analysis</p>

    <form action="/upload" method="post" enctype="multipart/form-data" class="space-y-6">
        <input type="hidden" name="workspace_id" value="{{ workspace.id }}">

        <!-- Optional: Link to existing deal -->
        <div>
            <label class="block text-sm font-medium mb-2">Link to Deal (Optional)</label>
            <select name="deal_id" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:border-emerald-500 focus:outline-none">
                <option value="">No deal - standalone call</option>
                {% if deals %}
                {% for deal in deals %}
                <option value="{{ deal.id }}">{{ deal.name }}{% if deal.company %} ({{ deal.company }}){% endif %}</option>
                {% endfor %}
                {% endif %}
            </select>
        </div>

        <!-- File Upload -->
        <div>
            <label class="block text-sm font-medium mb-2">Call Recording or Transcript</label>
            <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center hover:border-emerald-500 transition cursor-pointer"
                 onclick="document.getElementById('file-input').click()">
                <div id="file-display" class="text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p>Click to upload or drag and drop</p>
                    <p class="text-sm mt-1">Audio: MP3, WAV, M4A, WEBM | Text: TXT, MD</p>
                </div>
            </div>
            <input type="file" id="file-input" name="file" required
                   accept=".txt,.md,.mp3,.wav,.m4a,.webm,.mp4,.mpeg,.mpga,.oga,.ogg"
                   class="hidden"
                   onchange="updateFileDisplay(this)">
        </div>

        <!-- Instruction Set -->
        <div>
            <label class="block text-sm font-medium mb-2">Analysis Type</label>
            <select name="instruction_set" required
                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:border-emerald-500 focus:outline-none">
                <option value="">Select Sandler step to analyze...</option>
                {% for inst in instruction_sets %}
                <option value="{{ inst.id }}">{{ inst.name }} - {{ inst.description }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Submit -->
        <button type="submit"
                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-lg transition">
            <span class="ready">Analyze Call</span>
            <span class="loading">
                <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>
        </button>
    </form>

    <div class="mt-8 p-4 bg-gray-800 rounded-lg">
        <h3 class="font-semibold text-emerald-400 mb-2">Sandler Submarine Steps</h3>
        <ol class="text-sm text-gray-400 space-y-1 list-decimal list-inside">
            <li>Bonding & Rapport</li>
            <li>Up-Front Contract</li>
            <li>Pain Discovery</li>
            <li>Budget Discussion</li>
            <li>Decision Process</li>
            <li>Fulfillment/Presentation</li>
            <li>Post-Sell</li>
        </ol>
    </div>
</div>

<script>
function updateFileDisplay(input) {
    const display = document.getElementById('file-display');
    if (input.files && input.files[0]) {
        const file = input.files[0];
        display.innerHTML = `
            <svg class="w-12 h-12 mx-auto mb-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-emerald-400 font-medium">${file.name}</p>
            <p class="text-sm mt-1">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
        `;
    }
}

// Add loading state on form submit
document.querySelector('form').addEventListener('submit', function() {
    this.classList.add('htmx-request');
});
</script>
{% endblock %}
